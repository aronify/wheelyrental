# Partner Dashboard Implementation Guide

## Overview
This document describes the implementation of the partner (car-rental company) dashboard that works exclusively with the existing PostgreSQL database schema. All queries, actions, and permissions are driven directly by database tables and relationships.

## Database Schema Alignment

### Key Schema Facts

1. **Cars Table**
   - `company_id` (UUID, required) - Every car belongs to exactly one company
   - `status`: 'active', 'maintenance', 'retired' (NOT 'available', 'rented', etc.)
   - NO `owner_id` field in actual schema
   - NO `vin` field in actual schema

2. **Bookings Table**
   - `company_id` (UUID, required) - Every booking belongs to a company
   - `booking_reference` (TEXT, unique, 9-digit) - Auto-generated by trigger
   - `pickup_location_id` and `dropoff_location_id` (UUIDs) - Reference `company_locations`
   - `start_ts` and `end_ts` (TIMESTAMPTZ) - Rental period
   - NO `user_id` field - bookings are company-scoped
   - Status: 'pending', 'confirmed', 'picked_up', 'returned', 'cancelled'

3. **Companies Table**
   - `is_verified` (BOOLEAN) - NOT an enum
   - Simple structure: id, name, legal_name, is_verified, email, phone, website

4. **Company Locations Table**
   - `is_pickup`, `is_dropoff`, `is_hq`, `is_active` (all booleans)
   - One location per company can be HQ (unique constraint)
   - Used for booking pickup/dropoff locations

5. **Reviews Table**
   - Read-only for partners
   - Linked to bookings (one review per booking)
   - Only exists for bookings with 'returned' status

## Company-Scoped Data Isolation

### Getting User's Company

Since there's no direct `user_id -> company_id` relationship, we infer the company from:
1. User's cars (since `cars.company_id` is required)
2. If no cars exist, user must create one first

**Implementation:**
```typescript
// Get company_id from user's cars
const { data: userCar } = await supabase
  .from('cars')
  .select('company_id')
  .limit(1)
  .single()

const companyId = userCar?.company_id
```

### All Queries Must Be Company-Scoped

- **Cars**: `.eq('company_id', companyId)`
- **Bookings**: `.eq('company_id', companyId)`
- **Locations**: `.eq('company_id', companyId)`
- **Reviews**: `.eq('company_id', companyId)`
- **Payouts**: Must be scoped to company (if payout_requests has company_id)

## Implementation Details

### 1. Cars Management

**Query Pattern:**
```typescript
const { data: cars } = await supabase
  .from('cars')
  .select(`
    *,
    company:companies(
      id,
      name,
      is_verified,
      email,
      phone,
      website
    )
  `)
  .eq('company_id', companyId)
  .order('created_at', { ascending: false })
```

**Status Values:**
- 'active' - Car is available for rental
- 'maintenance' - Car is in maintenance (not available)
- 'retired' - Car is permanently unavailable

**Car Availability:**
- NOT controlled by `status` field
- Calculated from bookings: car is available if no overlapping bookings exist
- Status is only for operational states (maintenance, retired)

### 2. Bookings Management

**Query Pattern:**
```typescript
const { data: bookings } = await supabase
  .from('bookings')
  .select(`
    *,
    car:cars(...),
    customer:customers(...),
    pickup_location:company_locations!pickup_location_id(...),
    dropoff_location:company_locations!dropoff_location_id(...)
  `)
  .eq('company_id', companyId)
  .order('created_at', { ascending: false })
```

**Booking Reference:**
- 9-digit text field
- Auto-generated by database trigger `set_booking_reference_and_company_trg`
- Must be displayed prominently in UI

**Status Transitions:**
- 'pending' → 'confirmed' → 'picked_up' → 'returned'
- 'pending' → 'cancelled'
- 'confirmed' → 'cancelled'
- UI must enforce valid transitions

**Location References:**
- `pickup_location_id` and `dropoff_location_id` reference `company_locations`
- Must join with `company_locations` to display location names/addresses

### 3. Company Locations

**Query Pattern:**
```typescript
const { data: locations } = await supabase
  .from('company_locations')
  .select('*')
  .eq('company_id', companyId)
  .eq('is_active', true)
  .order('is_hq', { ascending: false })
```

**Location Types:**
- `is_pickup` - Can be used for pickup
- `is_dropoff` - Can be used for dropoff
- `is_hq` - Headquarters (one per company)
- `is_active` - Location is active

**HQ Location:**
- Automatically created/updated from profile data
- When profile address is updated, update/create HQ location

### 4. Reviews

**Query Pattern:**
```typescript
const { data: reviews } = await supabase
  .from('reviews')
  .select(`
    *,
    booking:bookings(...),
    car:cars(...),
    customer:customers(...)
  `)
  .eq('company_id', companyId)
  .order('created_at', { ascending: false })
```

**Read-Only:**
- Partners can NEVER create, edit, or delete reviews
- Display only for insights and reputation monitoring
- Only exist for bookings with 'returned' status

### 5. Company Profile

**Profile → HQ Location Sync:**
When profile is updated:
1. Update `profiles` table
2. Create or update HQ location in `company_locations`:
   - Set `is_hq = true`
   - Set `is_pickup = true` and `is_dropoff = true`
   - Use profile address data

**Implementation:**
```typescript
// After profile update
const { data: hqLocation } = await supabase
  .from('company_locations')
  .select('id')
  .eq('company_id', companyId)
  .eq('is_hq', true)
  .single()

if (hqLocation) {
  // Update existing HQ
  await supabase
    .from('company_locations')
    .update({
      name: profileData.agency_name,
      address_line_1: profileData.address,
      city: profileData.city,
      // ... other fields
    })
    .eq('id', hqLocation.id)
} else {
  // Create new HQ
  await supabase
    .from('company_locations')
    .insert({
      company_id: companyId,
      name: profileData.agency_name,
      is_hq: true,
      is_pickup: true,
      is_dropoff: true,
      // ... other fields
    })
}
```

### 6. Car Availability Calculation

**Implementation:**
```typescript
async function isCarAvailable(carId: string, startTs: Date, endTs: Date): Promise<boolean> {
  const { data: overlappingBookings } = await supabase
    .from('bookings')
    .select('id')
    .eq('car_id', carId)
    .eq('status', 'cancelled', { negate: true }) // Exclude cancelled
    .or(`and(start_ts.lte.${endTs.toISOString()},end_ts.gte.${startTs.toISOString()})`)
    .limit(1)
  
  return !overlappingBookings || overlappingBookings.length === 0
}
```

**Rules:**
- Car is available if no non-cancelled bookings overlap the period
- Status 'maintenance' or 'retired' makes car unavailable regardless of bookings
- Partners cannot manually override availability for booked dates

### 7. Verification Status

**Company Verification:**
- `companies.is_verified` (boolean)
- Affects UI behavior:
  - If not verified: Limit publishing actions
  - Show verification badge when `is_verified === true`
  - Only verified companies' cars show as "verified partner"

**Display Logic:**
```typescript
const isVerified = company?.is_verified === true
// Show verification badge only if isVerified
```

## Data Flow

### Partner Login → Dashboard
1. Authenticate user (auth.users)
2. Get user's company_id from cars
3. Load company data
4. Load company-scoped data (cars, bookings, locations, reviews)

### Creating a Car
1. User must have a company (or create one)
2. Insert car with `company_id`
3. Car status defaults to 'active'
4. Car availability calculated from bookings

### Updating Booking Status
1. Validate status transition is allowed
2. Update booking status
3. Recalculate car availability if needed

### Profile Update
1. Update `profiles` table
2. Sync to HQ location in `company_locations`
3. Optionally update `companies` table if needed

## Error Handling

### No Company Found
- If user has no cars, they cannot access company-scoped pages
- Show message: "Please create a car first to access your dashboard"
- Redirect to cars page with empty state

### Company Not Verified
- Show warning banner
- Limit certain actions (publishing, etc.)
- Still allow viewing and managing existing data

## Testing Checklist

- [ ] Cars query scoped to company_id
- [ ] Bookings query scoped to company_id
- [ ] Locations query scoped to company_id
- [ ] Reviews query scoped to company_id (read-only)
- [ ] Car availability calculated from bookings
- [ ] Booking status transitions enforced
- [ ] Profile updates sync to HQ location
- [ ] Verification status affects UI
- [ ] Company isolation (no cross-company data leakage)
- [ ] Booking reference displayed (9-digit)
- [ ] Location names displayed from company_locations



